$(window).unload(function(){if(get_cookie('channel_id')!=null&&window.location.href.indexOf('/post/')==-1){update_status('offline',false);}});$(document).ready(function(e){if(typeof $.global==='undefined'){$.global={};$.global.clear_autosave={};$.global.preload={};}
$.global.title='5works';$.global.history=[];sessionStorage.clear();if($('#header-container').length>0){init_avatar_uploader();}
refresh('#body');if(window.location.href.indexOf('#comment')!=-1){var comment_id=window.location.href.split('#')[1]
$('#'+comment_id).addClass('animate flash');offset_top=$('#'+comment_id).offset().top-45;$('html,body').animate({scrollTop:offset_top},'fast');}
$('.online-now .online-count').html($('#friends-online li.status.online').length); var channel_id;channel_id=get_cookie('channel_id');if(channel_id!=null){stream();start_pingpong();update_status('online');} 
$('.likes, .viewers, .quick-stats, .see-changes, .reply-to').tipsy({gravity:'s',live:true});
$('body').attr('class','animate fadeIn');var message=get_parameter_by_name('message');if(message!=""){$('div#message').html(message).show(0).delay(15000).hide(0);} 
var timezone=jstz.determine_timezone();var offset=timezone.offset();var sign=offset[0];var parts=offset.substring(1).split(':');var utcoffset=sign+(parts[0]*3600+parts[1]*60);set_cookie('utcoffset',utcoffset); $(window).scroll(function(){if($('div#overlay').is(':visible')==false&&$(window).scrollTop()+$(window).height()>get_doc_height()-250){console.log('scroll end');if($.global.loading!=true){$('a.next').trigger('click');}}}); $("#body, #overlay").on('click',"a.archive",function(e){ $('a.dropdown-menu-icon.active').parent().removeClass('active');$('a.dropdown-menu-icon.active').next('ul').hide();$('a.dropdown-menu-icon.active').removeClass('active');var href=$(this).attr("href");feed=$(this).parents('li.feed');message='<div class="undo">'+'This post has been archived. </strong>'+'<a class="undo" href="'+href.replace('/archive','/unarchive')+'">Undo</a>'+'</div>';feed.animate({opacity:0},0,function(e){$('section',feed).hide();$('> a',feed).hide();$('> i',feed).hide();feed.append(message);feed.animate({opacity:1},100);});$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:$(this).attr("href"),success:function(id){return false;}});return false;}); $("#body, #overlay").on('click',"a.remove",function(e){ $('a.dropdown-menu-icon.active').parent().removeClass('active');$('a.dropdown-menu-icon.active').next('ul').hide();$('a.dropdown-menu-icon.active').removeClass('active');var href=$(this).attr("href");feed=$(this).parents('li.feed');message='<div class="undo">'+'This post has been removed. </strong>'+'<a class="undo" href="'+href.replace('remove','undo_remove')+'">Undo</a>'+'</div>';feed.animate({opacity:0},0,function(e){$('section',feed).hide();$('> a',feed).hide();$('> i',feed).hide();feed.append(message);feed.animate({opacity:1},100);});$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:$(this).attr("href"),success:function(id){return false;}});return false;});$('body').on('click','a.scroll',function(e){id=$(this).attr('href');if($(id).length==0){open_in_overlay_mode('#!/feed/'+id.split('-')[1]);}else{$('html,body').animate({scrollTop:$(id).offset().top},'fast');}
})
$('#body, #overlay').on('click','a.undo',function(e){ $('a.dropdown-menu-icon.active').parent().removeClass('active');$('a.dropdown-menu-icon.active').next('ul').hide();$('a.dropdown-menu-icon.active').removeClass('active');feed=$(this).parents('li.feed');href=$(this).attr("href");$('.undo',feed).remove();$('section footer',feed).show();$('section',feed).show();$('> a',feed).show();$('> i',feed).show();try{$('input[name="to"]',feed).tokenInput('clear');$('input[name="viewers"]',feed).tokenInput('clear');}catch(err){}
if(href!=undefined){$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:$(this).attr("href"),success:function(id){console.log('Undo: '+id);return false;}});}
return false;})
$('#body, #overlay').on('click','a.forward',function(e){ $('a.dropdown-menu-icon.active').parent().removeClass('active');$('a.dropdown-menu-icon.active').next('ul').hide();$('a.dropdown-menu-icon.active').removeClass('active');feed=$(this).parents('li.feed section');href=$(this).attr("href");if(!$('footer.undo',feed).is(":visible")){show_loading();$.ajax({type:"GET",url:$(this).attr("href"),success:function(html){hide_loading();$('footer',feed).hide();feed.append(html);return false;}});}
return false;});$('#body, #overlay').on('submit','form.viewers',function(e){show_loading();feed=$(this).parents('li.feed');feed_id=feed.attr('id');$.ajax({type:"POST",url:$(this).attr('action'),data:$(this).serializeArray(),success:function(html){hide_loading();feed.replaceWith(html);refresh('#'+feed_id);return false;}});return false;})
var mark_as_read_timer=null;$("#body, #overlay").on('mouseenter','li.unread > section',function(){post_id=$(this).parent().attr('id'); mark_as_read_timer=setTimeout(function(){mark_as_read(post_id);},50);})
$('#body').on('mouseleave','li.unread > section',function(){id=$(this).parent().attr('id');if(mark_as_read_timer){clearTimeout(mark_as_read_timer)}});$('#body, #overlay').on('click','a.dropdown-menu-icon',function(){$('div#filters > ul').hide();if(!$(this).next('ul').is(':visible')){ $('div.dropdown-menu.active ul').hide();$('div.dropdown-menu.active').removeClass('active');$('a.dropdown-menu-icon.active').removeClass('active');}
$(this).parent().toggleClass('active');$(this).toggleClass('active');$(this).next('ul').toggle();return false;})
$('#body, #overlay, #popup').on('click','form.new footer a',function(){var id=$(this).attr('id');var form=$(this).parents('form'); $('tr.toggle:not(#'+id+')',form).hide();$('footer a:not(#'+id+')',form).removeClass('active');$(this).toggleClass('active');$('tr#'+id,form).toggle();if(id=='send-to'&&$('tr#send-to',form).is(':visible')){$('tr#send-to .token-input-list input[type="text"]').focus();}});$('header nav a.user"').click(function(){var dm=$(this).next('ul.dropdown-menu');if(dm.hasClass('hidden')){$('header nav ul.dropdown-menu').addClass('hidden');dm.removeClass('hidden');$('header nav .dropdown-menu-active').removeClass('dropdown-menu-active');$(this).addClass('dropdown-menu-active');}else{dm.addClass('hidden');$(this).removeClass('dropdown-menu-active');}
return false;});$('header nav a.view-notifications').click(function(){var dm=$(this).next('ul.dropdown-menu');if(dm.hasClass('hidden')){$('header nav ul.dropdown-menu').addClass('hidden');$('header nav ul.notifications').removeClass('hidden');$('header nav .dropdown-menu-active').removeClass('dropdown-menu-active');$(this).addClass('dropdown-menu-active');$.ajax({type:"OPTIONS",cache:false,url:'/notifications',dataType:"json",success:function(resp){var item=$('#unread-notification-counter');value=resp.unread_notifications_count;item.html(value);var title=document.title;var pattern=/^\(.*?\) /gi;var count=title.match(pattern);if(value!=0){$('#unread-notification-counter').removeClass('grey');if(count==null){document.title='('+$('#unread-notification-counter').html()+') '+title;}else{document.title=title.replace(count,'('+$('#unread-notification-counter').html()+') ');}}else{$('#unread-notification-counter').addClass('grey');if(count!=null){document.title=title.replace(count,'');}}
$('header nav ul.notifications ul').html(resp.body);refresh('header nav ul.notifications ul');}});}else{dm.addClass('hidden');$(this).removeClass('dropdown-menu-active');}
return false;}) 
$(window).bind('popstate',function(event){ console.log(event);var state=event.originalEvent.state;if(state){console.log(state);data=sessionStorage[state.path];if(state.path.indexOf('#!')!=-1){open_in_overlay_mode(state.path,data);}else{open_in_async_mode(state.path,state.rel,data);}}});$('#body, #overlay').on('click','a.rename',function(){filename=$(this).data('name');file_id=$(this).data('id');href=$(this).attr('href');var new_name=prompt('Enter a new name for "'+filename+'"');if(!new_name){return false;}
show_loading();$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},data:{name:new_name},url:href,success:function(resp){hide_loading();console.log(file_id);$('#body li#'+file_id).replaceWith(resp);$('#overlay li#'+file_id).replaceWith(resp);}});return false;})
$('#body, #overlay').on('click','a.toggle',function(){var new_class=$(this).data('class');var new_href=$(this).data('href');var new_name=$(this).data('name');var new_title=$(this).data('title');var href=$(this).attr('href');if(new_class!=undefined){$(this).data('class',$(this).attr('class'));}
$(this).data('name',$(this).html());$(this).data('href',href);$(this).data('title',$(this).attr('title'));if(new_class!=undefined){$(this).attr('class',new_class.replace('toggle','')+' toggle');}
$(this).html(new_name);$(this).attr('href',new_href);$(this).attr('title',new_title);if(href.indexOf('/pin')!=-1){$(this).parents('section').parents('li').addClass('pinned');}else if(href.indexOf('/unpin')!=-1){$(this).parents('section').parents('li').removeClass('pinned');}
if(href.indexOf('/like')!=-1){likes=$(this).next('span.likes');counter_id='#'+likes.children('span.counter').attr('id');incr(counter_id,1);if($(counter_id).html()!='0'){likes.removeClass('hidden');}else{likes.addClass('hidden');}}else if(href.indexOf('/unlike')!=-1){likes=$(this).next('span.likes');counter_id='#'+likes.children('span.counter').attr('id');incr(counter_id,-1);if($(counter_id).html()!='0'){likes.removeClass('hidden');}else{likes.addClass('hidden');}}
$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:href,success:function(resp){return false;}});return false;});$('#body, #overlay').on("click",'a.next',function(){$('span.loading',this).css('display','inline-block');$('span.text',this).html('Loading...');var more_button=$(this).parents('li');console.log('more button clicked');$.global.loading=true;$.ajax({type:"OPTIONS",cache:false,url:$(this).attr('href'),dataType:"html",success:function(html){$.global.loading=false;more_button.replaceWith(html);refresh('#body');refresh('#overlay');}});return false;});$('#popup').on('click','a.add-member',function(){var element=$(this);var href=$(this).attr('href');$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:href,success:function(resp){console.log('Added');}});href=href.replace('/remove_member','/add_member');element.replaceWith('<a href="'+href+'" class="button remove-member">Remove from Group</a>');return false;});$('#body, #overlay, #popup').on('click','a.follow',function(){var element=$(this);var href=$(this).attr('href');$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:href,success:function(resp){console.log('Followed');}});href=href.replace('/follow','/unfollow');if($(this).parents('#right-sidebar').length>0){element.replaceWith('<a href="'+href+'" class="unfollow">- Remove Contact</a>');}else{element.replaceWith('<a href="'+href+'" class="button unfollow">Remove from Contacts</a>');}
return false;});$('#body, #overlay, #popup').on('click','a.unfollow',function(){var element=$(this);var href=$(this).attr('href');$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:href,success:function(resp){console.log('Unfollowed');}});href=href.replace('/unfollow','/follow');if($(this).parents('#right-sidebar').length>0){element.replaceWith('<a href="'+href+'" class="follow">+ Add Contact</a>');}else{element.replaceWith('<a href="'+href+'" class="button follow">Add to Contacts</a>');}
return false;});$('div#body').on('click','a.unread-posts',function(){$('ul#stream > li.hidden').removeClass('hidden').fadeIn();$('div#unread-messages').hide();$('div#unread-messages span#unread').html('0');return false;})
$('#overlay').on("submit",'form#profile-update',function(){$.ajax({type:"POST",cache:false,url:$(this).attr('action'),data:$(this).serializeArray(),success:function(resp){if(resp=="Error"){show_error()}else{window.location.href=window.location.pathname;}
return false;}});return false;});$('#popup').on("submit",'form.new-group',function(){$.ajax({type:"POST",cache:false,url:$(this).attr('action'),data:$(this).serializeArray(),success:function(group_id){open_in_async_mode('/group/'+group_id,null,null,function(){open_in_popup_mode('/search?query=&type=people&ref=group-'+group_id);});return false;}});return false;});$('#body, #overlay, #popup').on("submit",'form.new:not(.overlay)',function(){button=$('input[type="submit"]',this);button.val('Posting...');var form=$(this);show_loading();$('span.empty').remove();if($('textarea.mention',form).length!=0){$('textarea.mention',form).mentionsInput('val',function(text){$('form.new textarea.marked-up').val(text);});} 
if(window.location.href.indexOf('#!')!=-1){url=window.location.hash;}else{url=window.location.href;}
$.global.clear_autosave[url]=$(this).attr('id'); $.global.preload=null;$('textarea.mention',form).val('').focus(); $('textarea.mention',form).mentionsInput('reset'); $('input.autocomplete',form).blur(); $('div#attachments',form).empty();$("textarea",form).css('height','auto');$.ajax({type:"POST",cache:false,headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:$(this).attr('action'),data:$(this).serializeArray(),error:function(jqXHR,textStatus,errorThrown){show_error();},success:function(resp){button.val('Share');hide_loading();feed_id=$(resp).attr('id');if($('#popup').is(':visible')){open_in_async_mode('/feed/'+feed_id.split('-')[1]);}else{if($('#'+feed_id).length==0){$('ul#stream').prepend(resp);}
feed_id=$('ul#stream li.feed').attr('id');refresh('ul#stream #'+feed_id);}}});return false;});$('#body, #overlay').on('click','a.update-comment',function(){$(this).addClass('hidden');comment_id=$(this).parents('li.comment').attr('id');update_form=$('#'+comment_id+' div.update-comment')
if(update_form.is(':visible')){update_form.addClass('hidden');$('#'+comment_id+' div.message').removeClass('hidden')
$('#'+comment_id+' div.footer').removeClass('hidden');}
else{update_form.removeClass('hidden');$('#'+comment_id+' div.message').addClass('hidden')
$('#'+comment_id+' div.footer').addClass('hidden');text=$('#'+comment_id+' textarea[name="message"]').data('prefill');$('#'+comment_id+' textarea._elastic').val(text);}
$('textarea.mention',update_form).focus();})
$('#body, #overlay').on('submit','div.update-comment form',function(){var comment_id=$(this).parents('li.comment').attr('id');$('textarea.mention',this).mentionsInput('val',function(text){$('#'+comment_id+' form.update-comment textarea.marked-up').val(text);});var textarea=$('textarea.mention',this);textarea.css('background','#f1f1f1');textarea.attr('readonly','readonly');$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:$(this).attr('action'),data:$(this).serializeArray(),error:function(jqXHR,textStatus,errorThrown){textarea.attr("readonly",false);textarea.attr('background','#fff');},success:function(text){textarea.attr("readonly",false);textarea.attr('background','#fff');$('#'+comment_id+' div.message .text').html(text);$('#'+comment_id+' div.update-comment textarea[name="message"]').data('prefill',text);$('#'+comment_id+' div.update-comment').addClass('hidden');$('#'+comment_id+' a.update-comment').removeClass('hidden');$('#'+comment_id+' div.message').removeClass('hidden')
$('#'+comment_id+' div.footer').removeClass('hidden')}})
return false;})
$('#body, #overlay').on('keydown','form.new-comment textarea, form.update-comment textarea',function(e){if(e.keyCode==13){ if(e.ctrlKey||e.shiftKey){var val=this.value;if(typeof this.selectionStart=="number"&&typeof this.selectionEnd=="number"){var start=this.selectionStart;this.value=val.slice(0,start)+"\n"+val.slice(this.selectionEnd);this.selectionStart=this.selectionEnd=start+1;}else if(document.selection&&document.selection.createRange){this.focus();var range=document.selection.createRange();range.text="\r\n";range.collapse(false);range.select();}
$(this).trigger('change');}
else{new_comment_form=$(this).parents('form');var ts=Math.round((new Date()).getTime()/1000);if(new_comment_form.data('last_submited')===undefined||ts-new_comment_form.data('last_submited')>1){new_comment_form.data('last_submited',ts);new_comment_form.trigger('submit');}}
return false;}
else if(e.keyCode==27){ var comment_id=$(this).parents('li.comment').attr('id');if($('#'+comment_id+' div.update-comment').length>0){$('#'+comment_id+' div.update-comment').addClass('hidden');$('#'+comment_id+' a.update-comment').removeClass('hidden');$('#'+comment_id+' div.message').removeClass('hidden')
$('#'+comment_id+' div.footer').removeClass('hidden')}}});$("#body, #overlay").on("submit",'form.new-comment',function(){var submit_button=$('input[type="submit"]',this);var submit_button_text=submit_button.val();submit_button.val('...');submit_button.attr('disabled','disabled');var textarea=$('textarea.mention',this);textarea.css('background','#f1f1f1');textarea.attr('readonly','readonly');comments_list_id=$(this).parents('ul.comments').attr('id');var feed_id=$(this).parents('li.feed').attr('id');$.global.disable_realtime_update=feed_id;console.log('disable realtime update: '+feed_id);$('textarea.mention',this).mentionsInput('val',function(text){$('#'+feed_id+' form.new-comment textarea.marked-up').val(text);}); if(window.location.href.indexOf('#!')!=-1){url=window.location.hash;}else{url=window.location.href;}
$.global.clear_autosave[url]=$(this).attr('id'); $.global.preload=null;$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:$(this).attr('action'),data:$(this).serializeArray(),error:function(jqXHR,textStatus,errorThrown){show_error();submit_button.val(submit_button_text);submit_button.attr('disabled',false);textarea.attr("readonly",false);textarea.css('background','#fff');},success:function(resp){submit_button.val(submit_button_text);submit_button.attr('disabled',false);textarea.attr("readonly",false);textarea.css('background','#fff'); $('#'+comments_list_id+" form.new-comment input[name='reply_to']").val('');$('#'+comments_list_id+" form.new-comment textarea.mention").val('').focus();$('#'+comments_list_id+" form.new-comment textarea.mention").css('height','26px'); $('#'+comments_list_id+' form.new-comment div.attachments').empty();$('#'+comments_list_id+' form.new-comment input[name="attachments"]').val('');var comment=$(resp);if($('#'+comment.attr('id')).length==0){$('#'+comments_list_id+' div.comments-list').append(resp);incr('#body #'+feed_id+' .quick-stats .comment-count',1);incr('#body #'+feed_id+' .comments-list .comment-count',1);incr('#overlay #'+feed_id+' .quick-stats .comment-count',1);incr('#overlay #'+feed_id+' .comments-list .comment-count',1);refresh('#'+comments_list_id);}}})
return false;});$("#body, #overlay").on("click",'a.toggle-comments',function(e){comments=$('ul.comments',$(this).parents('footer'));comments.toggle();return false;});$("#body, #overlay").on("click",'a.reply',function(e){console.log('a.reply clicked'); comment_id=$(this).attr('data-comment-id')
username=$(this).data('owner-name');user_id=$(this).data('owner-id');if(user_id){comments_list=$(this).parents('ul.comments:first');}else{comments_list=$('ul.comments',$(this).parents('footer'));}
if(!comments_list.is(":visible")){comments_list.toggle();}
mention_textarea=$('li.new-comment textarea.mention',comments_list)
mention_textarea.mentionsInput('reset');$('li.write-a-comment',comments_list).remove();$('li.new-comment',comments_list).show();mention_textarea.focus();if(username){var marked_up_text='@['+username+'](user:'+user_id+')'
mention_textarea.val(marked_up_text);mention_textarea.mentionsInput("update");$('li.new-comment input[name="reply_to"]',comments_list).val(comment_id);mention_textarea.val(mention_textarea.val()+': ');}else{mention_textarea.caretToEnd();}
mention_textarea.css('height','26px');preload_autocomplete();return false;});$('#body, #overlay').on('click','li.comment a.see-changes',function(){comment_id=$(this).parents('li.comment').attr('id');$('#'+comment_id+' .text').toggleClass('hidden');$('div.tipsy').remove();})
$('#body, #overlay').on('click','a.remove-comment',function(){var r=confirm("Delete this comment?");if(r==true){comment_id=$(this).parents('li').attr('id');$('#body #'+comment_id).fadeOut().remove();$('#overlay #'+comment_id).fadeOut().remove();$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:$(this).attr('href')})}
return false;})
$("#body, #overlay").on("click",'a.mark',function(e){$('html').trigger('click');count=$(this).data('count');counter_id=$(this).data('counter-id');if(count){count=parseInt(count);}else{count=0;}
var feed_id=$(this).parents('section').parents('li').attr('id');$('#body #'+feed_id).fadeOut().remove();$('#overlay #'+feed_id).fadeOut().remove();incr('#'+counter_id,count);var href=$(this).attr('href');$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:href})
return false;});$("nav").on("click",'a.notification',function(e){try{href=$(this).attr('href').split('#!')[1];redirect_to=href.split('?')[1].split('=')[1];$(this).removeClass('unread');}catch(err){ $.ajax({type:"GET",url:$(this).attr('href')})
$('#unread-notification-counter').html('0');$('#unread-notification-counter').fadeOut('fast');$('#unread-notification-counter').addClass('grey');$('ul.notifications a.unread').removeClass('unread');var title=document.title;var pattern=/^\(.*?\) /gi;var count=title.match(pattern);document.title=title.replace(count,'');return false;}
open_in_async_mode(redirect_to);$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:href,success:function(count){$('#unread-notification-counter').html(count);title=document.title;var pattern=/^\(.*?\) /gi;var counter=title.match(pattern);if(count=='0'){$('#unread-notification-counter').addClass('grey');document.title=title.replace(counter,'');}else{document.title=title.replace(counter,'('+count+') ');}}})
return false;});$("#body, #overlay").on("click",'a.remove-attachment',function(){console.log('remove-attachment clicked');form=$(this).parents('form');$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:$(this).attr("data-href"),success:function(id){$('#attachment-'+id).remove();var files=$('input[name="attachments"]',form).val();files=files.replace(id+',','');$('input[name="attachments"]',form).val(files);}});return false;});$("div#global").on("click",'a.async',function(){if($(this).hasClass('active')&&$("#overlay").is(":visible")){close_overlay();return false;}
$('#left-sidebar li a.active').removeClass('active');$(this).addClass('active');var href=$(this).attr('href');var rel=$(this).attr('rel');open_in_async_mode(href,rel);$('#global, #main').removeClass('global-default-styles');$('#left-sidebar').removeClass('left-sidebar-default-styles');return false;});$('textarea.mention').keyup(function(e){if(e.keyCode==27){ $('div.mentions-autocomplete-list').empty().hide();}});$('form#search-box').on('click','.reset',function(){$(this).fadeOut(100);$('form#search-box input').val('');$('form#search-box input').focus();$('form#search-box ul.dropdown-menu').hide();return false;});$('form#search-box input').focus(function(e){show_searchbox_dropdown($(this).val());$(this).addClass('highlight');$("form#search-box i.search-icon").addClass("highlight");if($('form#search-box input').val().length>0){$('form#search-box .reset').show();}});var typing_timer;$('form#search-box input[name="query"]').keyup(function(e){if(e.keyCode!=27){ query=$(this).val();if(e.keyCode==40){ var selected=$("form#search-box .dropdown-menu a.selected");if(selected.length==0){$("form#search-box .dropdown-menu li:first a").addClass('selected');}else{selected.removeClass("selected");if(selected.parent().next().length==0){selected.parents('ul').children('li').first().children().addClass("selected");}else{selected.parent().next().children().addClass("selected");}}
return false;}else if(e.keyCode===38){ var selected=$("form#search-box .dropdown-menu a.selected");if(selected.length==0){$("form#search-box .dropdown-menu li:last a").addClass('selected');}
selected.removeClass("selected");if(selected.parent().prev().length==0){selected.parents('ul').children('li').last().children().addClass("selected");}else{selected.parent().prev().children().addClass("selected");}
return false;}else{if(query!=''){show_searchbox_dropdown(query);}else{$('form#search-box ul.dropdown-menu').hide();$('form#search-box .reset').hide();$('form#search-box .spinner').hide();return false;}}
if(query.length>=1){if(e.keyCode!=13){typing_timer=setTimeout(function(){ var url=$('form#search-box').attr('action');query=$('form#search-box input[name="query"]').val();url=url+'?query='+query;try{$.global.preload_request.abort();}catch(err){}
$.global.preloading=query;$.global.preload_request=$.ajax({type:"OPTIONS",url:url,cache:true,headers:{'X-CSRFToken':get_cookie('_csrf_token')},dataType:"json",success:function(resp){if(typeof $.global.preload=='undefined'||$.global.preload==null){$.global.preload={};}
$.global.preload[query]=resp;if($.global.preload_show_results==true){$.global.preload_show_results=false;show_results(resp);}}});},300);}
else{ console.log('enter key pressed')
return false;}}}});$('form#search-box input[name="query"]').keydown(function(e){clearTimeout(typing_timer);});function show_results(resp){hide_searchbox_dropdown();hide_loading();if(resp.title){$.global.title=document.title;update_title(resp.title);}
if(!$.global.body){$.global.body=$("#body").html();$.global.scroll=$("body").scrollTop();console.log($.global.scroll);}
$("#body").hide();if(resp.body){$('div#overlay').html(resp.body);}else{$('div#overlay').html(resp);}
$('div#overlay').show();$.global.scroll=$("body").scrollTop();$('body').animate({scrollTop:0},'fast');refresh('div#overlay');}
$("header nav").on('submit','form#search-box',function(){$("form#search-box input[name='query']").blur();hide_searchbox_dropdown();var selected=$("form#search-box .dropdown-menu a.selected");if(selected.length!=0&&selected.attr('href').indexOf('/search?query=')==-1){selected.trigger('click');return false;}
var url=$(this).attr('action');var query=$('input[name="query"]',this).val();if(typeof $.global.preload=='undefined'||$.global.preload==null){$.global.preload={};}
if($.global.preload[query]!=null){show_results($.global.preload[query]);}else if($.global.preloading==query){console.log('wait preload results...');$.global.preload_show_results=true;show_loading();}else{show_loading();href=url+'?query='+query;$.global.search=$.ajax({type:"OPTIONS",cache:true,dataType:'json',url:href,headers:{'X-CSRFToken':get_cookie('_csrf_token')},error:function(jqXHR,textStatus,errorThrown){show_error();hide_loading();},success:function(resp){hide_loading();href='#!'+href;if($.global.history.length==10){key=$.global.history.pop();sessionStorage.removeItem(key);console.log('Remove '+key+' from Session Storage');}
sessionStorage[href]=JSON.stringify(resp);$.global.history.unshift(href);history.pushState({rel:null,path:href},'5works',href);show_results(resp);return false;}})}
return false;});$('#overlay').on("submit",'form.overlay',function(){var submit_button=$('input[type="submit"]',this);var submit_button_text=submit_button.val();submit_button.val('...');submit_button.attr('disabled','disabled');show_loading();$('textarea.mention',this).mentionsInput('val',function(text){$('form.new textarea.marked-up').val(text);});$.ajax({type:"POST",cache:false,url:$(this).attr('action'),data:$(this).serializeArray(),dataType:"json",success:function(resp){hide_loading();submit_button.val(submit_button_text);submit_button.attr('disabled',false);console.log(resp);if(resp.redirect!=undefined){open_in_async_mode(resp.redirect);return false;}
}});return false;});$("div#global").on("click",'a.overlay',function(){var href=$(this).attr('href');console.log('overlay clicked: '+href);open_in_overlay_mode(href);$('#global, #main').removeClass('global-default-styles');$('#left-sidebar').removeClass('left-sidebar-default-styles');return false;});$("div#global").on("click",'a.popup',function(){var href=$(this).attr('href');open_in_popup_mode(href);return false;});$('div#main').on('mouseenter','#overlay',function(){})
$('div#main').on('mouseleave','#overlay',function(){})
$('html').on('click',function(e){console.log(e) 
if(e.target.name!='query'&&!$('div#overlay').is(":visible")){hide_searchbox_dropdown();}
if(e.target.className=='background'&&$('#popup').is(':visible')){close_popup();}
if(e.target.name!='query'){hide_searchbox_dropdown();}
if(e.target.className!='menu-icon'){$('#global, #main').removeClass('global-default-styles');$('#left-sidebar').removeClass('left-sidebar-default-styles');}
$('div#filters > ul').hide();$('a.dropdown-menu-icon.active').parent().removeClass('active');$('a.dropdown-menu-icon.active').next('ul').hide();$('a.dropdown-menu-icon.active').removeClass('active');$('header nav ul.dropdown-menu').addClass('hidden');$('header nav .dropdown-menu-active').removeClass('dropdown-menu-active');});$("#body, #overlay").on('click','a.see-more',function(){$(this).prev('div').hide();$(this).next('div.hidden').show();$(this).hide();})
$("#body, #overlay").on("click",'.current',function(){$(".current ul").remove();$(".current").addClass("async");$(".current").removeClass("current");});$("body").on('submit',"#subscription",function(){$.ajax({type:"POST",url:'/notify_me',data:$(this).serializeArray(),});$('div#footer').fadeOut(0);$('div#intro h1').fadeOut(0,function(){$('div#intro h1').html('Thanks!').fadeIn('fast');});$('div.info').fadeOut(0,function(){$('div.info').html("You're now in the waiting list.<br>We'll email you when 5works is ready.").fadeIn(3000);});return false;})
if(window.location.hash.indexOf('#!')!=-1){open_in_overlay_mode(window.location.hash);}
$('#body, #overlay').on('focus','form.new:not(.doc.overlay) textarea',function(){$('form.new:not(.doc.overlay) textarea').elastic();$('footer').show();if((window.location.pathname.indexOf('news_feed')!=-1||window.location.pathname.indexOf('group/')!=-1)&&$('form.new a.active').length==0){$('form.new a#send-to').addClass('active');$('form.new tr#send-to').show();}else if(window.location.pathname.indexOf('files')!=-1&&$('form.new a.active').length==0){$('form.new a#attach').trigger('click');}
preload_autocomplete();});$('#body').on('change','input#show-archived-posts',function(){checked=$(this).is(':checked');console.log(checked)
if(checked){set_cookie('show_all',1);}else{delete_cookie('show_all');}
$('#left-sidebar li#news-feed > a').trigger('click');})
$('#body').on('click','a.archive-from-here',function(){var ts=$(this).data('ts').replace(' at ',' ');var r=confirm('Are you sure?\n\n'+'All posts older than "'+ts+'" will be archived.\n\n'+'Press OK to continue, or Cancel to go back.');if(r==false){$('html').trigger('click');return false;}else{$('html').trigger('click');show_loading();$.ajax({type:"POST",headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:$(this).attr('href'),success:function(message){hide_loading();$('#left-sidebar li#news-feed > a').trigger('click');}});return false;}})
$('#body').on('click','a.filter',function(){ $('a.dropdown-menu-icon.active').parent().removeClass('active');$('a.dropdown-menu-icon.active').next('ul').hide();$('a.dropdown-menu-icon.active').removeClass('active');var ul=$(this).next('ul');ul.toggle();return false;})
$('#header-container').on('click','a#menu-toggle',function(){if($('#left-sidebar').width()<=0){$('#global, #main').addClass('global-default-styles');$('#left-sidebar').addClass('left-sidebar-default-styles');}else{$('#global, #main').removeClass('global-default-styles');$('#left-sidebar').removeClass('left-sidebar-default-styles');}})
$('#body, #overlay').on('click','a.view-previous-comments',function(){var post_id=$(this).parents('li.feed').attr('id');var hidden_comments=$('#'+post_id+' ul.comments li.comment.hidden');hidden_comments.slice(-5).removeClass('hidden');if($('#'+post_id+' ul.comments li.comment.hidden').length>0){$('#'+post_id+' ul.comments .displayed-count').html($('#'+post_id+' ul.comments li.comment:not(.hidden)').length)}else{$(this).parents('li.action').remove();}})
$('#global').on('click','a.online-now',function(){$('ul#friends-online').toggleClass('hidden');return false;})
$('#popup').on('keyup','form input[name="query"]',function(e){if(e.keyCode==13){ return false;}else if(e.keyCode==27){close_popup();return false;}
query=$(this).val();url=$(this).parent().attr('action');if(query.length>1){try{clearTimeout($.global.people_search_timeout)}catch(err){}
$.global.people_search_timeout=setTimeout(function(){try{$.global.people_search_request.abort();}catch(err){}
$.global.people_search_request=$.ajax({type:'POST',headers:{'X-CSRFToken':get_cookie('_csrf_token')},url:url+'&query='+query,async:true,success:function(resp){$('#popup ul.people').html(resp);}})},300)}})});var guiders=(function($){var guiders={};guiders.version="1.2.7";guiders._defaultSettings={attachTo:null,autoFocus:false,buttons:[{name:"Close"}],buttonCustomHTML:"",classString:null,description:"Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.",highlight:null,isHashable:true,offset:{top:null,left:null},onShow:null,onHide:null,overlay:false,position:0,title:"Sample title goes here",width:400,xButton:false};guiders._htmlSkeleton=["<div class='guider'>","  <div class='guider_content'>","    <h1 class='guider_title'></h1>","    <div class='guider_close'></div>","    <p class='guider_description'></p>","    <div class='guider_buttons'>","    </div>","  </div>","  <div class='guider_arrow'>","  </div>","</div>"].join("");guiders._arrowSize=42;guiders._buttonElement="<a></a>";guiders._buttonAttributes={"href":"javascript:void(0);"};guiders._closeButtonTitle="Close";guiders._currentGuiderID=null;guiders._guiders={};guiders._lastCreatedGuiderID=null;guiders._nextButtonTitle="Next";guiders._offsetNameMapping={"topLeft":11,"top":12,"topRight":1,"rightTop":2,"right":3,"rightBottom":4,"bottomRight":5,"bottom":6,"bottomLeft":7,"leftBottom":8,"left":9,"leftTop":10};guiders._windowHeight=0;guiders._addButtons=function(myGuider){var guiderButtonsContainer=myGuider.elem.find(".guider_buttons");if(myGuider.buttons===null||myGuider.buttons.length===0){guiderButtonsContainer.remove();return;}
for(var i=myGuider.buttons.length-1;i>=0;i--){var thisButton=myGuider.buttons[i];var thisButtonElem=$(guiders._buttonElement,$.extend({"class":"guider_button","html":thisButton.name},guiders._buttonAttributes,thisButton.html||{}));if(typeof thisButton.classString!=="undefined"&&thisButton.classString!==null){thisButtonElem.addClass(thisButton.classString);}
guiderButtonsContainer.append(thisButtonElem);if(thisButton.onclick){thisButtonElem.bind("click",thisButton.onclick);}else if(!thisButton.onclick&&thisButton.name.toLowerCase()===guiders._closeButtonTitle.toLowerCase()){thisButtonElem.bind("click",function(){guiders.hideAll();});}else if(!thisButton.onclick&&thisButton.name.toLowerCase()===guiders._nextButtonTitle.toLowerCase()){thisButtonElem.bind("click",function(){!myGuider.elem.data('locked')&&guiders.next();});}}
if(myGuider.buttonCustomHTML!==""){var myCustomHTML=$(myGuider.buttonCustomHTML);myGuider.elem.find(".guider_buttons").append(myCustomHTML);}
if(myGuider.buttons.length===0){guiderButtonsContainer.remove();}};guiders._addXButton=function(myGuider){var xButtonContainer=myGuider.elem.find(".guider_close");var xButton=$("<div></div>",{"class":"x_button","role":"button"});xButtonContainer.append(xButton);xButton.click(function(){guiders.hideAll();});};guiders._attach=function(myGuider){if(typeof myGuider!=='object'){return;}
var attachTo=$(myGuider.attachTo);var myHeight=myGuider.elem.innerHeight();var myWidth=myGuider.elem.innerWidth();if(myGuider.position===0||attachTo.length===0){myGuider.elem.css("position","fixed");myGuider.elem.css("top",($(window).height()-myHeight)/3+"px");myGuider.elem.css("left",($(window).width()-myWidth)/2+"px");return;}
var base=attachTo.offset();var top=base.top;var left=base.left;var topMarginOfBody=$("body").outerHeight(true)-$("body").outerHeight(false);top-=topMarginOfBody;if(guiders._offsetNameMapping[myGuider.position]){myGuider.position=guiders._offsetNameMapping[myGuider.position];}
var attachToHeight=attachTo.innerHeight();var attachToWidth=attachTo.innerWidth();var bufferOffset=0.9*guiders._arrowSize;var offsetMap={1:[-bufferOffset-myHeight,attachToWidth-myWidth],2:[0,bufferOffset+attachToWidth],3:[attachToHeight/2-myHeight/2,bufferOffset+attachToWidth],4:[attachToHeight-myHeight,bufferOffset+attachToWidth],5:[bufferOffset+attachToHeight,attachToWidth-myWidth],6:[bufferOffset+attachToHeight,attachToWidth/2-myWidth/2],7:[bufferOffset+attachToHeight,0],8:[attachToHeight-myHeight,-myWidth-bufferOffset],9:[attachToHeight/2-myHeight/2,-myWidth-bufferOffset],10:[0,-myWidth-bufferOffset],11:[-bufferOffset-myHeight,0],12:[-bufferOffset-myHeight,attachToWidth/2-myWidth/2]};var offset=offsetMap[myGuider.position];top+=offset[0];left+=offset[1];var positionType="absolute";if(attachTo.css("position")=="fixed"){positionType="fixed";top-=$(window).scrollTop();left-=$(window).scrollLeft();}
if(myGuider.offset.top!==null){top+=myGuider.offset.top;}
if(myGuider.offset.left!==null){left+=myGuider.offset.left;}
return myGuider.elem.css({"position":positionType,"top":top,"left":left});};guiders._guiderById=function(id){if(typeof guiders._guiders[id]==="undefined"){throw"Cannot find guider with id "+id;}
return guiders._guiders[id];};guiders._showOverlay=function(){$("#guider_overlay").fadeIn("fast",function(){if(this.style.removeAttribute){this.style.removeAttribute("filter");}});};guiders._highlightElement=function(selector){$(selector).addClass('guider_highlight');};guiders._dehighlightElement=function(selector){$(selector).removeClass('guider_highlight');};guiders._hideOverlay=function(){$("#guider_overlay").fadeOut("fast");};guiders._initializeOverlay=function(){if($("#guider_overlay").length===0){$("<div id=\"guider_overlay\"></div>").hide().appendTo("body");}};guiders._styleArrow=function(myGuider){var position=myGuider.position||0;if(!position){return;}
var myGuiderArrow=$(myGuider.elem.find(".guider_arrow"));var newClass={1:"guider_arrow_down",2:"guider_arrow_left",3:"guider_arrow_left",4:"guider_arrow_left",5:"guider_arrow_up",6:"guider_arrow_up",7:"guider_arrow_up",8:"guider_arrow_right",9:"guider_arrow_right",10:"guider_arrow_right",11:"guider_arrow_down",12:"guider_arrow_down"};myGuiderArrow.addClass(newClass[position]);var myHeight=myGuider.elem.innerHeight();var myWidth=myGuider.elem.innerWidth();var arrowOffset=guiders._arrowSize/2;var positionMap={1:["right",arrowOffset],2:["top",arrowOffset],3:["top",myHeight/2-arrowOffset],4:["bottom",arrowOffset],5:["right",arrowOffset],6:["left",myWidth/2-arrowOffset],7:["left",arrowOffset],8:["bottom",arrowOffset],9:["top",myHeight/2-arrowOffset],10:["top",arrowOffset],11:["left",arrowOffset],12:["left",myWidth/2-arrowOffset]};var position=positionMap[myGuider.position];myGuiderArrow.css(position[0],position[1]+"px");};guiders._showIfHashed=function(myGuider){var GUIDER_HASH_TAG="guider=";var hashIndex=window.location.hash.indexOf(GUIDER_HASH_TAG);if(hashIndex!==-1){var hashGuiderId=window.location.hash.substr(hashIndex+GUIDER_HASH_TAG.length);if(myGuider.id.toLowerCase()===hashGuiderId.toLowerCase()){guiders.show(myGuider.id);}}};guiders.reposition=function(){var currentGuider=guiders._guiders[guiders._currentGuiderID];guiders._attach(currentGuider);};guiders.next=function(){var currentGuider=guiders._guiders[guiders._currentGuiderID];if(typeof currentGuider==="undefined"){return;}
currentGuider.elem.data('locked',true);var nextGuiderId=currentGuider.next||null;if(nextGuiderId!==null&&nextGuiderId!==""){var myGuider=guiders._guiderById(nextGuiderId);var omitHidingOverlay=myGuider.overlay?true:false;guiders.hideAll(omitHidingOverlay,true);if(currentGuider&&currentGuider.highlight){guiders._dehighlightElement(currentGuider.highlight);}
guiders.show(nextGuiderId);}};guiders.createGuider=function(passedSettings){if(passedSettings===null||passedSettings===undefined){passedSettings={};} 
myGuider=$.extend({},guiders._defaultSettings,passedSettings);myGuider.id=myGuider.id||String(Math.floor(Math.random()*1000));var guiderElement=$(guiders._htmlSkeleton);myGuider.elem=guiderElement;if(typeof myGuider.classString!=="undefined"&&myGuider.classString!==null){myGuider.elem.addClass(myGuider.classString);}
myGuider.elem.css("width",myGuider.width+"px");var guiderTitleContainer=guiderElement.find(".guider_title");guiderTitleContainer.html(myGuider.title);guiderElement.find(".guider_description").html(myGuider.description);guiders._addButtons(myGuider);if(myGuider.xButton){guiders._addXButton(myGuider);}
guiderElement.hide();guiderElement.appendTo("body");guiderElement.attr("id",myGuider.id);if(typeof myGuider.attachTo!=="undefined"&&myGuider!==null){guiders._attach(myGuider)&&guiders._styleArrow(myGuider);}
guiders._initializeOverlay();guiders._guiders[myGuider.id]=myGuider;guiders._lastCreatedGuiderID=myGuider.id;if(myGuider.isHashable){guiders._showIfHashed(myGuider);}
return guiders;};guiders.hideAll=function(omitHidingOverlay,next){next=next||false;$(".guider:visible").each(function(index,elem){var myGuider=guiders._guiderById($(elem).attr('id'));if(myGuider.onHide){myGuider.onHide(myGuider,next);}});$(".guider").fadeOut("fast");var currentGuider=guiders._guiders[guiders._currentGuiderID];if(currentGuider&&currentGuider.highlight){guiders._dehighlightElement(currentGuider.highlight);}
if(typeof omitHidingOverlay!=="undefined"&&omitHidingOverlay===true){}else{guiders._hideOverlay();}
return guiders;};guiders.show=function(id){if(!id&&guiders._lastCreatedGuiderID){id=guiders._lastCreatedGuiderID;}
var myGuider=guiders._guiderById(id);if(myGuider.overlay){guiders._showOverlay(); if(myGuider.highlight){guiders._highlightElement(myGuider.highlight);}}
if(myGuider.onShow){myGuider.onShow(myGuider);}
guiders._attach(myGuider);myGuider.elem.fadeIn("fast").data("locked",false);guiders._currentGuiderID=id;var windowHeight=guiders._windowHeight=$(window).height();var scrollHeight=$(window).scrollTop();var guiderOffset=myGuider.elem.offset();var guiderElemHeight=myGuider.elem.height();var isGuiderBelow=(scrollHeight+windowHeight<guiderOffset.top+guiderElemHeight);var isGuiderAbove=(guiderOffset.top<scrollHeight);if(myGuider.autoFocus&&(isGuiderBelow||isGuiderAbove)){setTimeout(guiders.scrollToCurrent,10);}
$(myGuider.elem).trigger("guiders.show");return guiders;};guiders.scrollToCurrent=function(){var currentGuider=guiders._guiders[guiders._currentGuiderID];if(typeof currentGuider==="undefined"){return;}
var windowHeight=guiders._windowHeight;var scrollHeight=$(window).scrollTop();var guiderOffset=currentGuider.elem.offset();var guiderElemHeight=currentGuider.elem.height();var scrollToHeight=Math.round(Math.max(guiderOffset.top+(guiderElemHeight/2)-(windowHeight/2),0));window.scrollTo(0,scrollToHeight);}; var _resizing=undefined;$(window).resize(function(){if(typeof(_resizing)!=="undefined"){clearTimeout(_resizing);}
_resizing=setTimeout(function(){_resizing=undefined;if(typeof(guiders)!=="undefined"){guiders.reposition();}},20);});return guiders;}).call(this,jQuery);